<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜çŸ¥ã‚¯ã‚¨ã‚¹ãƒˆ - PIXEL TREASURE</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body, html, button { 
            margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; 
            font-family: 'DotGothic16', sans-serif;
            cursor: crosshair;
        }

.sakura {
    position: fixed; top: -10px; z-index: 3000;
    pointer-events: none; animation: fall linear forwards;
}
@keyframes fall {
    to { transform: translateY(100vh) rotate(360deg); }
}

.sparkle {
    position: absolute;
    pointer-events: none;
    z-index: 1000;
    animation: sparkle-burst 1.5s ease-out forwards;
    font-size: 20px;
}

@keyframes sparkle-burst {
    0% { transform: translate(0, 0) scale(0); opacity: 1; }
    100% { 
        transform: translate(var(--tx), var(--ty)) scale(1.5); 
        opacity: 0; 
    }
}
        
#rank-icon { font-size: 1.5rem; margin-right: 5px; vertical-align: middle; }

        .leaflet-tile { image-rendering: pixelated !important; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #000; }

        #ui-layer {
            position: absolute; top: 15px; left: 15px; z-index: 100;
            background: rgba(0, 0, 0, 0.85); color: #ffd700;
            padding: 15px; border: 4px solid #ffd700;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5);
            min-width: 180px; text-shadow: 2px 2px 0 #000;
        }

        #current-rank {
            display: block; margin-top: 8px; padding: 4px 8px;
            background: #ffd700; color: #000; text-shadow: none;
        }

        .custom-tooltip {
            background: #000 !important; color: #ffd700 !important;
            border: 2px solid #ffd700 !important; font-family: 'DotGothic16', sans-serif !important;
            font-size: 14px !important; text-shadow: 1px 1px 0 #000;
            border-radius: 0px !important; box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }

        .rank-up-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .rank-card {
            border: 6px double #ffd700; padding: 40px; background: #1a1a1a;
            text-shadow: 3px 3px 0 #000; color: #ffd700; text-align: center;
        }

        #quiz-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .quiz-content {
            background: #fffbe6; color: #333; padding: 30px;
            border: 6px double #8b4513; width: 85%; max-width: 400px;
            text-align: center;
        }
        .option-btn {
            display: block; width: 100%; margin: 12px 0; padding: 15px;
            background: #2a5d9a; color: white; border: 4px solid #000; 
            font-family: 'DotGothic16', sans-serif; font-size: 1.1rem;
            text-shadow: 2px 2px 0 #000; cursor: pointer;
        }

        .hidden { display: none !important; }
        .pixel-icon { 
            image-rendering: pixelated; 
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5));
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h2 style="margin:0; font-size: 1.4rem;">ğŸ—¡ï¸ é«˜çŸ¥ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
        <p id="score" style="margin:10px 0 0 0;">ç§˜å®: 0 / 45</p>
        <p style="margin:12px 0 0 0; font-size: 0.8rem; color: #ffd700;">ç¾åœ¨ã®ç§°å·</p>
        <span id="current-rank">åœŸä½ã®æ—…äºº</span>
    </div>

    <div id="map"></div>

    <div id="rank-modal" class="rank-up-overlay hidden" onclick="this.classList.add('hidden')">
        <div class="rank-card">
            <div style="font-size: 1.2rem;">â€¼ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—â€¼</div>
            <div id="rank-display" style="font-size: 2.5rem; color:#fff; margin:20px 0;"></div>
            <div id="ijin-talk" style="color: #ffa500; line-height: 1.6; white-space: pre-wrap;"></div>
            <p style="font-size: 0.9rem; color: #888; margin-top: 30px;">(ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹)</p>
        </div>
    </div>

    <div id="quiz-modal" class="hidden">
        <div class="quiz-content">
            <h2 id="quiz-spot-name" style="color: #2a5d9a; margin-top: 0;"></h2>
            <p id="quiz-question" style="margin-bottom: 20px; font-weight: bold;"></p>
            <div id="quiz-options"></div>
            <button onclick="closeQuiz()" style="margin-top:20px; background:none; border:none; color:gray; text-decoration:underline; font-family: 'DotGothic16'; cursor:pointer;">é€ƒã’ã‚‹</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const map = L.map('map', {
            tap: true, zoomControl: false, minZoom: 4, maxZoom: 18
        }).setView([33.35, 133.4], 9);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let score = 0;

        const boxClosedBlue = L.icon({
            iconUrl: 'blue.png', iconSize: [45, 45], iconAnchor: [22, 40], className: 'pixel-icon'
        });
        const boxClosedRed = L.icon({
            iconUrl: 'red.png', iconSize: [45, 45], iconAnchor: [22, 40], className: 'pixel-icon'
        });
        const boxOpenGold = L.icon({
            iconUrl: 'gold.png', iconSize: [45, 45], iconAnchor: [22, 40], className: 'pixel-icon'
        });

        const questSpots = [
            { name: "é«˜çŸ¥å¸‚ãƒ»éµœæ¥å·£", level: "â˜…3", pos: [33.5420, 133.5120], q: "ã€é›£èª­åœ°åã€‘ã€Œéµœæ¥å·£ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã†ãã™", "ã†ã“ã™", "ã†ãã‚‹ã™"], ans: "ã†ãã‚‹ã™", solved: false },
            { name: "é«˜çŸ¥å¸‚ãƒ»åˆæœˆ", level: "â˜…3", pos: [33.5850, 133.5200], q: "ã€é›£èª­åœ°åã€‘ã€Œåˆæœˆã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã¯ã¥ã", "ã¿ã‹ã¥ã", "ã†ã„ã¥ã"], ans: "ã¿ã‹ã¥ã", solved: false },
            { name: "å®‰èŠ¸å¸‚ãƒ»åˆ¥å½¹", level: "â˜…2", pos: [33.5500, 133.9500], q: "ã€é›£èª­åœ°åã€‘ã€Œåˆ¥å½¹ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã¹ã¤ã‚„ã", "ã¹ã£ã¡ã‚ƒã", "ã‚ã‹ã‚Œã‚„ã"], ans: "ã¹ã£ã¡ã‚ƒã", solved: false },
            { name: "å—å›½å¸‚ãƒ»å²¡è±Šç”º", level: "â˜…3", pos: [33.5930, 133.6070], q: "ã€é›£èª­åœ°åã€‘ã€Œå²¡è±Šã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ãŠã‹ã‚†ãŸã‹", "ãŠã‹ã¨ã‚ˆ", "ãŠã“ã†"], ans: "ãŠã“ã†", solved: false },
            { name: "é¦™ç¾å¸‚ãƒ»äº”ç™¾è”µ", level: "â˜…3", pos: [33.6700, 133.7800], q: "ã€é›£èª­åœ°åã€‘ã€Œäº”ç™¾è”µã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã„ãŠã‚ã„", "ã„ãŠãã‚‰", "ã”ã²ã‚ƒããã‚‰"], ans: "ã„ãŠã‚ã„", solved: false },
            { name: "ç”°é‡ç”ºãƒ»æ·Œæ¿¤", level: "â˜…3", pos: [33.4300, 134.0100], q: "ã€é›£èª­åœ°åã€‘ã€Œæ·Œæ¿¤ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ãªãŠ", "ã—ã‚‡ã†ã¨ã†", "ãªã¿"], ans: "ã—ã‚‡ã†ã¨ã†", solved: false },
            { name: "é¦¬è·¯æ‘ãƒ»é­šæ¢ç€¬", level: "â˜…3", pos: [33.6300, 134.1100], q: "ã€é›£èª­åœ°åã€‘ã€Œé­šæ¢ç€¬ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ãã‚‡ã‚Šã‚‡ã†ãœ", "ã‚„ãªã›", "ã†ãŠã‚„ãªã›"], ans: "ã‚„ãªã›", solved: false },
            { name: "å®¿æ¯›å¸‚ãƒ»å®¿æ¯›", level: "â˜…2", pos: [32.9400, 132.7200], q: "ã€é›£èª­åœ°åã€‘ã€Œå®¿æ¯›ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã—ã‚…ãã‚‚ã†", "ã‚„ã©ã’", "ã™ãã‚‚"], ans: "ã™ãã‚‚", solved: false },
            { name: "åœŸä½æ¸…æ°´å¸‚ãƒ»éµæ›", level: "â˜…2", pos: [32.7800, 132.9500], q: "ã€é›£èª­åœ°åã€‘ã€Œéµæ›ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã‹ã„ã‹ã‘", "ã‹ãã‹ã‘", "ã‘ã‚“ãŒã„"], ans: "ã‹ã„ã‹ã‘", solved: false },
            { name: "å››ä¸‡åå¸‚ãƒ»ç§‹ç”°", level: "â˜…2", pos: [32.9500, 132.9300], q: "ã€é›£èª­åœ°åã€‘ã€Œç§‹ç”°ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã‚ããŸ", "ã‚ã„ã ", "ã—ã‚…ã†ã§ã‚“"], ans: "ã‚ã„ã ", solved: false },
            { name: "å¤§è±Šç”ºãƒ»ç²Ÿç”Ÿ", level: "â˜…3", pos: [33.7800, 133.6800], q: "ã€é›£èª­åœ°åã€‘ã€Œç²Ÿç”Ÿã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã‚ã‚ãŠ", "ã‚ãŠã†", "ã‚ã‚ãªã¾"], ans: "ã‚ãŠã†", solved: false },
            { name: "åœŸä½ç”ºãƒ»æºœäº•", level: "â˜…3", pos: [33.7500, 133.5500], q: "ã€é›£èª­åœ°åã€‘ã€Œæºœäº•ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ãŸã‚ã„", "ã‚Šã‚…ã†ã›ã„", "ã‚†ã‚‹ã„"], ans: "ã‚†ã‚‹ã„", solved: false },
            { name: "ã„ã®ç”ºãƒ»äº•æµ", level: "â˜…3", pos: [33.5500, 133.4000], q: "ã€é›£èª­åœ°åã€‘ã€Œäº•æµã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã‚†ã‚‹", "ã„ã‚Šã‚…ã†", "ã„ãªãŒã‚Œ"], ans: "ã‚†ã‚‹", solved: false },
            { name: "æ¢¼åŸç”ºãƒ»ä¸Šæˆ", level: "â˜…2", pos: [33.4600, 132.9000], q: "ã€é›£èª­åœ°åã€‘ã€Œä¸Šæˆã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã†ãˆãªã‚Š", "ã†ã‚ãªã‚", "ã‹ã¿ã—ã’"], ans: "ã†ã‚ãªã‚", solved: false },
            { name: "å››ä¸‡åç”ºãƒ»å¤©ãƒå·", level: "â˜…1", pos: [33.2200, 133.0500], q: "ã€é›£èª­åœ°åã€‘ã€Œå¤©ãƒå·ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã¦ã‚“ã®ã‹ã‚", "ã‚ã¾ã®ãŒã‚", "ã‚ã„ãŒãŒã‚"], ans: "ã‚ã¾ã®ãŒã‚", solved: false },
            { name: "æ—¥é«˜æ‘ãƒ»èµ¤æ±¢", level: "â˜…3", pos: [33.5400, 133.3500], q: "ã€é›£èª­åœ°åã€‘ã€Œèµ¤æ±¢ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã‚ã‹ã—ãŠ", "ã‚ã‹ã¬ãŸ", "ã‚ã‹ã©ã‚"], ans: "ã‚ã‹ã¬ãŸ", solved: false },
            { name: "é»’æ½®ç”ºãƒ»æµ®é­", level: "â˜…2", pos: [33.0300, 133.0100], q: "ã€é›£èª­åœ°åã€‘ã€Œæµ®é­ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", ops: ["ã†ãã¶ã¡", "ã†ãã‚€ã¡", "ãµã¹ã‚“"], ans: "ã†ãã¶ã¡", solved: false },
            { name: "é«˜çŸ¥ã®æŸ‘æ©˜", level: "â˜…1", pos: [33.4800, 134.0500], q: "é«˜çŸ¥çœŒã®æ±éƒ¨ã§ç››ã‚“ã«æ ½åŸ¹ã•ã‚Œã€ç”Ÿç”£é‡æ—¥æœ¬ä¸€ã‚’èª‡ã‚‹æŸ‘æ©˜ã¯ï¼Ÿ", ops: ["ãƒ¬ãƒ¢ãƒ³", "ã‚†ãš", "ã™ã ã¡"], ans: "ã‚†ãš", solved: false },
            { name: "å‚æœ¬é¾é¦¬èª•ç”Ÿåœ°", level: "â˜…1", pos: [33.5614, 133.5285], q: "é¾é¦¬ãŒç”Ÿã¾ã‚ŒãŸã“ã®å ´æ‰€ã€ç¾åœ¨ã¯ä½•ãŒç«‹ã£ã¦ã„ã‚‹ï¼Ÿ", ops: ["éŠ…åƒ", "è¨˜å¿µç¢‘", "å®Ÿç‰©å¤§ã®å®¶"], ans: "è¨˜å¿µç¢‘", solved: false },
            { name: "ä¸­å²¡æ…å¤ªéƒåƒ", level: "â˜…2", pos: [33.2482, 134.1755], q: "æ…å¤ªéƒã®å‡ºèº«åœ°ã¯ã©ã“ã®æ‘ï¼Ÿ", ops: ["é¦¬è·¯æ‘", "åŒ—å·æ‘", "èŠ¸è¥¿æ‘"], ans: "åŒ—å·æ‘", solved: false },
            { name: "æ—¥æœ¬æœ€å¾Œã®æ¸…æµ", level: "â˜…1", pos: [32.9900, 132.9300], q: "å¤§è¦æ¨¡ãªãƒ€ãƒ ãŒãªãã€ã€Œæ—¥æœ¬æœ€å¾Œã®æ¸…æµã€ã¨å‘¼ã°ã‚Œã¦ã„ã‚‹å·ã¯ï¼Ÿ", ops: ["ä»æ·€å·", "å››ä¸‡åå·", "é¡å·"], ans: "å››ä¸‡åå·", solved: false },
            { name: "æ­¦å¸‚åŠå¹³å¤ªæ—§å®…", level: "â˜…3", pos: [33.5786, 133.5855], q: "æ­¦å¸‚åŠå¹³å¤ªï¼ˆãŸã‘ã¡ ã¯ã‚“ãºã„ãŸï¼‰ãŒåä¹—ã£ã¦ã„ãŸåˆ¥åï¼ˆå·ï¼‰ã¯ï¼Ÿ", ops: ["å—å†¥ï¼ˆãªã‚“ã‚ã„ï¼‰", "ç‘å±±ï¼ˆãšã„ã–ã‚“ï¼‰", "é›…æ¥½ï¼ˆã†ãŸï¼‰"], ans: "ç‘å±±ï¼ˆãšã„ã–ã‚“ï¼‰", solved: false },
            { name: "é«˜çŸ¥ã®å¤ç¥­ã‚Š", level: "â˜…1", pos: [33.5585, 133.5310], q: "é³´å­ï¼ˆãªã‚‹ã“ï¼‰ã‚’é³´ã‚‰ã—ã¦è¸Šã‚‹ã€é«˜çŸ¥ç™ºç¥¥ã®ãŠç¥­ã‚Šã¯ï¼Ÿ", ops: ["é˜¿æ³¢è¸Šã‚Š", "ã‚ˆã•ã“ã„ç¥­ã‚Š", "ã­ã¶ãŸç¥­ã‚Š"], ans: "ã‚ˆã•ã“ã„ç¥­ã‚Š", solved: false },
            { name: "é«˜çŸ¥åŸãƒ»è¿½æ‰‹é–€", level: "â˜…1", pos: [33.5601, 133.5330], q: "é«˜çŸ¥åŸã®å¤©å®ˆé–£ï¼ˆã¦ã‚“ã—ã‚…ã‹ãï¼‰ã¯ã€æ±Ÿæˆ¸æ™‚ä»£ã‹ã‚‰æ®‹ã‚‹ã€Œç¾å­˜â—¯å¤©å®ˆã€ã®ä¸€ã¤ï¼Ÿ", ops: ["ç¾å­˜12å¤©å®ˆ", "ç¾å­˜5å¤©å®ˆ", "ç¾å­˜100å¤©å®ˆ"], ans: "ç¾å­˜12å¤©å®ˆ", solved: false },
            { name: "å²©å´å¼¥å¤ªéƒç”Ÿå®¶", level: "â˜…2", pos: [33.5215, 133.9212], q: "ä¸‰è±ã®ãƒãƒ¼ã‚¯ã®ä¸€ã¤ã®ç”±æ¥ã«ãªã£ãŸå²©å´å®¶ã®å®¶ç´‹ã¯ï¼Ÿ", ops: ["ä¸‰ã¤æŸï¼ˆã¿ã¤ãŒã—ã‚ï¼‰", "ä¸‰ã¤é±—ï¼ˆã¿ã¤ã†ã‚ã“ï¼‰", "ä¸‰éšè±ï¼ˆã•ã‚“ãŒã„ã³ã—ï¼‰"], ans: "ä¸‰éšè±ï¼ˆã•ã‚“ãŒã„ã³ã—ï¼‰", solved: false },
            { name: "è¿‘è—¤é•·æ¬¡éƒã®ç¢‘", level: "â˜…2", pos: [33.5650, 133.5350], q: "é¥…é ­å±‹ã®æ¯å­ã ã£ãŸé•·æ¬¡éƒã®æ„›ç§°ã¯ï¼Ÿ", ops: ["ãŠè“å­é•·æ¬¡éƒ", "ç ‚ç³–å±‹é•·æ¬¡éƒ", "é¥…é ­å±‹é•·æ¬¡éƒ"], ans: "é¥…é ­å±‹é•·æ¬¡éƒ", solved: false },
            { name: "å²¡è±Šå±±", level: "â˜…3", pos: [33.5930, 133.6062], q: "é•·å®—æˆ‘éƒ¨å…ƒè¦ªï¼ˆã¡ã‚‡ã†ãã‹ã¹ ã‚‚ã¨ã¡ã‹ï¼‰ã®å±…åŸã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã®ã¯ï¼Ÿ", ops: ["æµ¦æˆ¸åŸ", "å²¡è±ŠåŸ", "æœå€‰åŸ"], ans: "å²¡è±ŠåŸ", solved: false },
            { name: "é«˜çŸ¥ã®ãƒ‘ãƒ³", level: "â˜…1", pos: [33.5650, 133.5400], q: "ä¸¸ã„ãƒ‘ãƒ³ã®ã¾ã‚ã‚Šã«ã‚«ã‚¹ãƒ†ãƒ©ç”Ÿåœ°ãŒã¤ã„ãŸã€é«˜çŸ¥ç™ºç¥¥ã®ãƒ‘ãƒ³ã¯ï¼Ÿ", ops: ["ãƒ¡ãƒ­ãƒ³ãƒ‘ãƒ³", "å¸½å­ãƒ‘ãƒ³", "ãƒ¡ã‚¬ãƒãƒ‘ãƒ³"], ans: "å¸½å­ãƒ‘ãƒ³", solved: false },
            { name: "è‹¥å®®å…«å¹¡å®®", level: "â˜…3", pos: [33.5042, 133.5511], q: "å…ƒè¦ªãŒåˆé™£ã®ç¥ˆé¡˜ã‚’ã—ãŸç¥ç¤¾ã¯ï¼Ÿ", ops: ["åœŸä½ç¥ç¤¾", "è‹¥å®®å…«å¹¡å®®ï¼ˆã‚ã‹ã¿ã‚„ã¯ã¡ã¾ã‚“ãã†ï¼‰", "æ½®æ±Ÿå¤©æº€å®®ï¼ˆã†ã—ãŠãˆã¦ã‚“ã¾ã‚“ãã†ï¼‰"], ans: "è‹¥å®®å…«å¹¡å®®ï¼ˆã‚ã‹ã¿ã‚„ã¯ã¡ã¾ã‚“ãã†ï¼‰", solved: false },
            { name: "é›ªè¹Šå¯º", level: "â˜…3", pos: [33.5028, 133.5505], q: "é›ªè¹Šå¯ºï¼ˆã›ã£ã‘ã„ã˜ï¼‰ã®åå‰ã®ç”±æ¥ã¨ãªã£ãŸã€å…ƒè¦ªï¼ˆã‚‚ã¨ã¡ã‹ï¼‰ã®æ³•åã¯ï¼Ÿ", ops: ["é›ªè¹Šå®—éºŸï¼ˆã›ã£ã‘ã„ãã†ã‚Šã‚“ï¼‰", "é›ªè¹Šé“çœŸï¼ˆã›ã£ã‘ã„ã©ã†ã—ã‚“ï¼‰", "é›ªè¹Šæ•ä¸‰ï¼ˆã›ã£ã‘ã„ã˜ã‚‡ã•ã‚“ï¼‰"], ans: "é›ªè¹Šæ•ä¸‰ï¼ˆã›ã£ã‘ã„ã˜ã‚‡ã•ã‚“ï¼‰", solved: false },
            { name: "æ¿å£é€€åŠ©åƒ", level: "â˜…1", pos: [33.5601, 133.5312], q: "æ¿å£é€€åŠ©ãŒå‰µè¨­ã«é–¢ã‚ã£ãŸæ—¥æœ¬åˆã®å›½æ”¿æ”¿å…šã¯ï¼Ÿ", ops: ["è‡ªç”±å…š", "é€²æ­©å…š", "ç«‹æ†²æ”¹é€²å…š"], ans: "è‡ªç”±å…š", solved: false },
            { name: "è‡ªç”±æ°‘æ¨©è¨˜å¿µé¤¨", level: "â˜…2", pos: [33.5550, 133.5211], q: "ã€Œè‡ªç”±ã¯ã©ã“ãã“ã‹ã‚‰å¹ãã€ã¨è¨€ã‚ã‚ŒãŸï¼Ÿ", ops: ["åœŸä½ã®æµ·åŸã‚ˆã‚Š", "åœŸä½ã®å±±é–“ã‚ˆã‚Š", "ç¶­æ–°ã®é‡Œã‚ˆã‚Š"], ans: "åœŸä½ã®å±±é–“ã‚ˆã‚Š", solved: false },
            { name: "æ’­ç£¨å±‹å®—å¾³ã®å¢“", level: "â˜…1", pos: [33.5600, 133.5430], q: "ã€Œã¯ã‚Šã¾ã‚„æ©‹ã€ã®åã®ç”±æ¥ã¨ãªã£ãŸã€å½“æ™‚ã®è±ªå•†ã®å±‹å·ã¯ï¼Ÿ", ops: ["åœŸä½å±‹", "é«˜çŸ¥å±‹", "æ’­ç£¨å±‹"], ans: "æ’­ç£¨å±‹", solved: false },
            { name: "æ—§å±±å†…å®¶ä¸‹å±‹æ•·", level: "â˜…2", pos: [33.5562, 133.5321], q: "å¹•æœ«ã®è—©ä¸»ãƒ»å±±å†…å®¹å ‚ï¼ˆã‚„ã¾ã†ã¡ ã‚ˆã†ã©ã†ï¼‰ãŒè‡ªã‚‰ç§°ã—ãŸé…’å¥½ãã®é›…å·ã¯ï¼Ÿ", ops: ["é…”ã„ã©ã‚Œå¤§å", "åœŸä½ã®è™", "é¯¨æµ·é…”ä¾¯"], ans: "é¯¨æµ·é…”ä¾¯", solved: false },
            { name: "é¾æ²³æ´", level: "â˜…3", pos: [33.6033, 133.7436], q: "é¾ä¹³çŸ³ã¨ä¸€ä½“åŒ–ã—ãŸã€ä¸–ç•Œçš„ã«ã‚‚çã—ã„å¼¥ç”ŸåœŸå™¨ã®é€šç§°ã¯ï¼Ÿ", ops: ["æ™‚ã®å™¨", "ç¥ã®å£º", "çŸ³ã®çš¿"], ans: "ç¥ã®å£º", solved: false },
            { name: "æ´¥é‡ç”ºãƒ»å››å›½ã‚«ãƒ«ã‚¹ãƒˆ", level: "â˜…2", pos: [33.4750, 133.0035], q: "ã€Œæ—¥æœ¬ã®ã‚¹ã‚¤ã‚¹ã€ã¨ã‚‚å‘¼ã°ã‚Œã‚‹å››å›½ã‚«ãƒ«ã‚¹ãƒˆã€‚åœ°è¡¨ã«éœ²å‡ºã—ã¦ã„ã‚‹ç™½ã„å²©ã¯ä½•ï¼Ÿ", ops: ["èŠ±å´—å²©", "çŸ³ç°å²©", "å¤§ç†çŸ³"], ans: "çŸ³ç°å²©", solved: false },
            { name: "é«˜çŸ¥ã®é£²é…’æ–‡åŒ–", level: "â˜…1", pos: [33.5605, 133.5380], q: "é«˜çŸ¥ã§ãŠé…’ã‚’é£²ã‚€éš›ã€ãŠåº§æ•·éŠã³ã§ä½¿ã‚ã‚Œã‚‹ã€Œç©´ã®ç©ºã„ãŸç›ƒã€ã®åå‰ã¯ï¼Ÿ", ops: ["å¯æ¯ï¼ˆã¹ãã¯ã„ï¼‰", "ãŠçŒªå£", "ãƒ¯ã‚¤ãƒ³ã‚°ãƒ©ã‚¹"], ans: "å¯æ¯ï¼ˆã¹ãã¯ã„ï¼‰", solved: false },
            { name: "é ˆå´å¸‚ãƒ»åç‰©æ–™ç†", level: "â˜…2", pos: [33.3930, 133.2950], q: "é ˆå´å¸‚ã®åç‰©ã‚°ãƒ«ãƒ¡ã§ã€åœŸé‹ã§æä¾›ã•ã‚Œã‚‹ç†±ã€…ã®ãƒ©ãƒ¼ãƒ¡ãƒ³ã¯ï¼Ÿ", ops: ["åœŸä½ãƒ©ãƒ¼ãƒ¡ãƒ³", "é‹ç„¼ããƒ©ãƒ¼ãƒ¡ãƒ³", "é ˆå´ãƒ–ãƒ©ãƒƒã‚¯"], ans: "é‹ç„¼ããƒ©ãƒ¼ãƒ¡ãƒ³", solved: false },
            { name: "æ¢¼åŸç”ºãƒ»é›²ã®ä¸Šã®å›³æ›¸é¤¨", level: "â˜…3", pos: [33.4815, 132.9150], q: "æ¢¼åŸç”ºã®ç¾ã—ã„æœ¨é€ å»ºç¯‰ã‚’å¤šãæ‰‹æ›ã‘ãŸã€æ–°å›½ç«‹ç«¶æŠ€å ´ã‚‚è¨­è¨ˆã—ãŸå»ºç¯‰å®¶ã¯ï¼Ÿ", ops: ["å®‰è—¤å¿ é›„ï¼ˆã‚ã‚“ã©ã† ãŸã§ãŠï¼‰", "éšˆç ”å¾ï¼ˆãã¾ ã‘ã‚“ã”ï¼‰", "ä¸¹ä¸‹å¥ä¸‰ï¼ˆãŸã‚“ã’ ã‘ã‚“ãã†ï¼‰"], ans: "éšˆç ”å¾ï¼ˆãã¾ ã‘ã‚“ã”ï¼‰", solved: false },
            { name: "å¤§æœˆç”ºãƒ»æŸå³¶", level: "â˜…2", pos: [32.7680, 132.6280], q: "ã€Œèˆ¹ãŒæµ®ã„ã¦è¦‹ãˆã‚‹ã€ã»ã©ã®é€æ˜åº¦ã‚’èª‡ã‚‹æŸå³¶ã€‚ã“ã“ã§è¦‹ã‚‰ã‚Œã‚‹é­šã®ç¨®é¡ã¯æ—¥æœ¬å…¨ä½“ã®ä½•åˆ†ã®ä¸€ï¼Ÿ", ops: ["ç´„3åˆ†ã®1", "ç´„5åˆ†ã®1", "ç´„10åˆ†ã®1"], ans: "ç´„3åˆ†ã®1", solved: false },
            { name: "åœŸä½æ¸…æ°´ãƒ»å‰äºº", level: "â˜…1", pos: [32.7785, 132.9550], q: "æ±Ÿæˆ¸æ™‚ä»£ã«ã‚¢ãƒ¡ãƒªã‚«ã¸æ¸¡ã‚Šã€æ—¥ç±³ã®æ¶ã‘æ©‹ã¨ãªã£ãŸåœŸä½æ¸…æ°´å‡ºèº«ã®äººç‰©ã¯ï¼Ÿ", ops: ["ã‚¸ãƒ§ãƒ³ä¸‡æ¬¡éƒ", "ãƒšãƒªãƒ¼", "ä¸­å²¡æ…å¤ªéƒ"], ans: "ã‚¸ãƒ§ãƒ³ä¸‡æ¬¡éƒ", solved: false },
            { name: "ä½ç”°æ²ˆä¸‹æ©‹", level: "â˜…1", pos: [32.9984, 132.9333], q: "æ²ˆä¸‹æ©‹ã«æ¬„å¹²ï¼ˆæ‰‹ã™ã‚Šï¼‰ãŒãªã„æœ€å¤§ã®ç†ç”±ã¯ï¼Ÿ", ops: ["å»ºè¨­è²»ç”¨ã‚’æŠ‘ãˆã‚‹ãŸã‚", "å·ã«é£›ã³è¾¼ã¿ã‚„ã™ãã™ã‚‹ãŸã‚", "æµæœ¨ãªã©ãŒå¼•ã£ã‹ã‹ã‚Šã«ããã™ã‚‹ãŸã‚"], ans: "æµæœ¨ãªã©ãŒå¼•ã£ã‹ã‹ã‚Šã«ããã™ã‚‹ãŸã‚", solved: false },
            { name: "å®¤æˆ¸å²¬ç¯å°", level: "â˜…2", pos: [33.2472, 134.1751], q: "ã“ã®ç¯å°ã«ã‚ã‚‹æ—¥æœ¬æœ€å¤§ç´šã®ãƒ¬ãƒ³ã‚ºã®ç›´å¾„ã¯ï¼Ÿ", ops: ["1.0m", "5.0m", "2.6m"], ans: "2.6m", solved: false },
            { name: "é³´ç„¡ç¥ç¤¾", level: "â˜…2", pos: [33.4358, 133.3985], q: "å‚é“ãŒæµ·ã«å‘ã‹ã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€åˆ¥åã€ŒåœŸä½ã®ä½•ã€ã¨å‘¼ã°ã‚Œã‚‹ï¼Ÿ", ops: ["åœŸä½ã®å‡ºé›²", "åœŸä½ã®å®®å³¶", "åœŸä½ã®æˆç”°"], ans: "åœŸä½ã®å®®å³¶", solved: false },
            { name: "é­šæ¢ç€¬æ£®æ—é‰„é“", level: "â˜…2", pos: [33.6210, 134.1105], q: "ã‹ã¤ã¦æœ¨æã‚’é‹ã‚“ã ã“ã®é‰„é“ã‚’èµ°ã‚‹æ©Ÿé–¢è»Šã®å¾©å…ƒè»Šä¸¡ã®æ„›ç§°ã¯ï¼Ÿ", ops: ["åœŸä½å·", "ã‚Šã‚“ã¦ã¤å·", "ã—ã‚“ãŸã‚ã†å·"], ans: "ã—ã‚“ãŸã‚ã†å·", solved: false }
        ];

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function initMarkers() {
            questSpots.forEach((spot, index) => {
                const isNandoku = spot.q.includes("é›£èª­");
                const markerIcon = isNandoku ? boxClosedBlue : boxClosedRed;
                const marker = L.marker(spot.pos, { icon: markerIcon }).addTo(map);
                spot.marker = marker;
                
                marker.bindTooltip(`<b>${spot.level} ${spot.name}</b>`, {
                    direction: 'top', offset: [0, -25], className: 'custom-tooltip'
                });

                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (spot.solved) {
                        alert("ã“ã®ç§˜å®ã¯ã™ã§ã«æ‰‹ã«å…¥ã‚ŒãŸãœã‚ˆï¼");
                    } else {
                        openQuiz(index);
                    }
                });
            });
        }

        function openQuiz(index) {
            const spot = questSpots[index];
            document.getElementById('quiz-spot-name').innerText = spot.name;
            document.getElementById('quiz-question').innerText = spot.q;
            
            const optionsDiv = document.getElementById('quiz-options');
            optionsDiv.innerHTML = ""; 

            const shuffledOptions = [...spot.ops];
            shuffleArray(shuffledOptions);

            shuffledOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, spot.ans, index);
                optionsDiv.appendChild(btn);
            });
            document.getElementById('quiz-modal').classList.remove('hidden');
        }

function createSparkles(latlng) {
    
    const point = map.latLngToContainerPoint(latlng);
    const container = document.getElementById('map');

    for (let i = 0; i < 15; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.innerText = 'âœ¨';
        const tx = (Math.random() - 0.5) * 200 + 'px';
        const ty = (Math.random() - 0.5) * 200 + 'px';
        sparkle.style.setProperty('--tx', tx);
        sparkle.style.setProperty('--ty', ty);
        sparkle.style.left = point.x + 'px';
        sparkle.style.top = point.y + 'px';
        
        container.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 1500);
    }
}

function checkAnswer(userAns, correctAns, index) {
    const spot = questSpots[index];
    const isNandoku = spot.q.includes("é›£èª­");

    if (userAns === correctAns) {
        createSparkles(spot.pos);
        // ----------------

        let winMsg = "æ­£è§£ï¼ç§˜å®ã‚²ãƒƒãƒˆãœã‚ˆï¼";
        if (spot.level === "â˜…3") {
            winMsg = "ã€é©šæ„•ã€‘ãŠã‚“ã—ã‚ƒã‚ã€ã¾ã£ã“ã¨è©³ã—ã„ã­ã‡ï¼â˜…3ã‚’è§£ãã¨ã¯å¤©æ‰ãœã‚ˆï¼";
        } else if (isNandoku) {
            winMsg = `ã€Œ${spot.ans}ã€ï¼\nã‚ˆã†èª­ã‚ãŸã­ã‡ã€åœ°å…ƒã®äººã‚‚ã³ã£ãã‚Šãœã‚ˆï¼`;
        } else if (spot.level === "â˜…1") {
            winMsg = "æ­£è§£ï¼ã“ã‚Œã¯åŸºæœ¬ãœã‚ˆã€‚ã‚µã‚¯ã‚µã‚¯é›†ã‚ã‚‹ãŒã˜ã‚ƒï¼";
        }
        
        alert(winMsg);
        
        if (!spot.solved) {
            score++;
            spot.solved = true; 
            updateUI();
            spot.marker.setIcon(boxOpenGold);
            showRankUpEffect(score);
        }
    } else {
        let failMsg = `ãƒã‚ºãƒ¬ï¼æ®‹å¿µã‚„ã£ãŸã­ã‡ã€‚`;
        if (spot.level === "â˜…3") failMsg = "ã“ã‚Œã¯é›£ã—ã‹ã£ãŸã¡ã‚„â€¦ã€‚";
        alert(`${failMsg}\næ­£è§£ã¯ã€Œ${correctAns}ã€ãœã‚ˆï¼`);
    }
    closeQuiz();
}

        function getRankInfo(s) {
            if (s >= 45) return { name: "åœŸä½ã®å¤ªå®ˆ", icon: "ğŸ¯" };
            if (s >= 35) return { name: "åœŸä½ã®è‹±é›„", icon: "ğŸŒŠ" };
            if (s >= 25) return { name: "ç¶­æ–°ã®å¿—å£«", icon: "âš“" };
            if (s >= 15) return { name: "æœŸå¾…ã®è‹¥æ­¦è€…", icon: "âš”ï¸" };
            if (s >= 5) return { name: "åœŸä½ã®è¶³è»½", icon: "ğŸ¶" };
            return { name: "åœŸä½ã®æ—…äºº", icon: "ğŸ‘£" };
        }

        function updateUI() {
            const rankInfo = getRankInfo(score);
            document.getElementById('score').innerText = `ç§˜å®: ${score} / ${questSpots.length}`;
            document.getElementById('current-rank').innerHTML = `<span id="rank-icon">${rankInfo.icon}</span>${rankInfo.name}`;
        }

        function createSakura() {
            for (let i = 0; i < 50; i++) {
                const sakura = document.createElement('div');
                sakura.className = 'sakura';
                sakura.innerText = 'ğŸŒ¸';
                sakura.style.left = Math.random() * 100 + 'vw';
                sakura.style.fontSize = (Math.random() * 10 + 10) + 'px';
                sakura.style.animationDuration = (Math.random() * 3 + 2) + 's';
                sakura.style.opacity = Math.random();
                document.body.appendChild(sakura);
                setTimeout(() => sakura.remove(), 5000);
            }
        }

        function showRankUpEffect(currentScore) {
            const rankDisplay = document.getElementById('rank-display');
            const ijinTalk = document.getElementById('ijin-talk');
            const rankInfo = getRankInfo(currentScore);
            let msg = "";

            if (currentScore === 5) {
                msg = "ã€æ—…ç«‹ã¡ã®äºˆæ„Ÿã€‘\nåœŸä½ã®åœ°ã‚’è¸ã¿ã—ã‚ã€æ­´å²ã®æ‰‰ãŒé–‹ã„ãŸã€‚é“ã®ã‚Šã¯ã¾ã å§‹ã¾ã£ãŸã°ã‹ã‚Šãœã‚ˆï¼";
            } else if (currentScore === 15) {
                msg = "ã€é«˜é³´ã‚‹é¼“å‹•ã€‘\nãŠã‚“ã—ã‚ƒã‚ã®çŸ¥è­˜ã€ã¾ã£ã“ã¨å¤§ã—ãŸã‚‚ã‚“ã˜ã‚ƒã€‚è‹¥æ­¦è€…ã¨ã—ã¦ã®åå£°ãŒåºƒã¾ã‚Šã‚ˆã‚‹ãœã‚ˆï¼";
            } else if (currentScore === 25) {
                msg = "ã€ç‡ƒãˆä¸ŠãŒã‚‹å¿—ã€‘\nè’æ³¢ã‚’è¶Šãˆã€é«˜çŸ¥ã®æ·±æ·µã«è§¦ã‚ŒãŸã€‚å¿—å£«ã®é­‚ãŒãã®èº«ã«å®¿ã‚Šå§‹ã‚ãŸã‚ˆã†ã˜ã‚ƒï¼";
            } else if (currentScore === 35) {
                msg = "ã€ä¼èª¬ã®ç›®æ’ƒè€…ã€‘\nã‚‚ã¯ã‚„åœŸä½ã«çŸ¥ã‚‰ã¬ã“ã¨ãªã—ã€‚ãã®åã¯å››å›½å…¨åœŸã«è½Ÿãã€è‹±é›„ã¨ã—ã¦èªã‚Šç¶™ãŒã‚Œã‚‹ã‚ã†ï¼";
            } else if (currentScore === 45) {
                msg = "ã€è‡³é«˜ã®åˆ°é”ç‚¹ã€‘\nå…¨ç§˜å®ã€å®Œå…¨åˆ¶è¦‡ï¼ãŠã‚“ã—ã‚ƒã‚ã“ããŒã“ã®å›½ã‚’çµ±ã¹ã‚‹ã€Œå¤ªå®ˆã€ã€‚åœŸä½ã®å¤œæ˜ã‘ã‚’ãã®æ‰‹ã§æ´ã‚“ã ãœã‚ˆï¼";
            }

            if (msg !== "") {
                createSakura();
                rankDisplay.innerText = `${rankInfo.icon} ${rankInfo.name}`;
                ijinTalk.innerText = msg;
                document.getElementById('rank-modal').classList.remove('hidden');
            }
        }

        function closeQuiz() { document.getElementById('quiz-modal').classList.add('hidden'); }
        
        window.onload = () => { 
            initMarkers();
            alert(
                "ã€é«˜çŸ¥ã‚¯ã‚¨ã‚¹ãƒˆã€‘\n\n" +
                `æ­£è§£ã—ã¦å…¨${questSpots.length}å€‹ã®ç§˜å®ã‚’é›†ã‚ã‚‹ãŒã˜ã‚ƒï¼\n\n` +
                "â–¼å®ç®±ã®è‰²ã«ã¤ã„ã¦\n" +
                "ğŸŸ¦ é’ã®ç®±ï¼šåœ°åã®èª­ã¿æ–¹ï¼ˆé›£èª­åœ°åï¼‰\n" +
                "ğŸŸ¥ èµ¤ã®ç®±ï¼šæ­´å²ã‚„è¦³å…‰ã‚¹ãƒãƒƒãƒˆã®çŸ¥è­˜\n\n" +
                "â–¼é›£æ˜“åº¦ã«ã¤ã„ã¦\n" +
                "â˜…1ï¼šåˆç´šã€€â˜…2ï¼šä¸­ç´šã€€â˜…3ï¼šä¸Šç´šï¼ˆæ¿€ãƒ ã‚ºï¼‰\n\n" +
                "æº–å‚™ã¯ãˆãˆã‹ï¼Ÿã„ã–ã€åœŸä½ã®æ—…ã¸å‡ºç™ºãœã‚ˆï¼"
            ); 
        };
    </script>
</body>
</html>
